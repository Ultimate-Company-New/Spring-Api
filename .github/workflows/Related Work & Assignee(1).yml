name: Related Work & Assignee

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string

jobs:
  assignee-and-story:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Check and Assign Agent
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            if (pr.assignees.length === 0) {
              console.log('No assignee found. Assigning nahushr...');
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                assignees: ['nahushr']
              });
            } else {
              console.log(`PR already has assignees: ${pr.assignees.map(a => a.login).join(', ')}`);
            }

      - name: Check Linked Story and Reopen if Closed
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');

            // 1. Check Labels for 'development'
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            const labels = prData.labels.map(label => label.name.toLowerCase());

            // 2. Check GraphQL for Sidebar Linked Issues
            const query = `query($owner:String!, $name:String!, $number:Int!) {
              repository(owner:$owner, name:$name) {
                pullRequest(number:$number) {
                  closingIssuesReferences(first: 10) {
                    nodes { 
                      number 
                      state
                    }
                  }
                }
              }
            }`;
            const variables = {
              owner: context.repo.owner,
              name: context.repo.repo,
              number: prNumber
            };
            const result = await github.graphql(query, variables);
            const linkedIssues = result.repository.pullRequest.closingIssuesReferences.nodes;
            const hasSidebarLink = linkedIssues.length > 0;

            console.log(`Labels: ${labels.join(', ')}`);
            console.log(`Sidebar (GraphQL) linked issues count: ${linkedIssues.length}`);

            if (!labels.includes('development') && !hasSidebarLink) {
              core.setFailed('PR failure: No associated development story found. Please add the "development" label or link an issue via the GitHub sidebar.');
              return;
            }

            // 3. Reopen closed linked issues
            for (const issue of linkedIssues) {
              if (issue.state === 'CLOSED') {
                console.log(`Found closed linked issue: #${issue.number}. Reopening...`);
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'open'
                });
                console.log(`Successfully reopened issue #${issue.number}`);
              } else {
                console.log(`Linked issue #${issue.number} is already ${issue.state}.`);
              }
            }
