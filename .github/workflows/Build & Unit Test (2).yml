name: Build & Unit Test

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        run: mvn -B package -DskipTests
        working-directory: SpringApi

      - name: Run Unit Tests
        id: run_tests
        run: mvn -B test
        working-directory: SpringApi
        continue-on-error: true

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'SpringApi/target/surefire-reports';
            let totalUnitTests = 0;
            let totalUnitFailures = 0;
            let totalUnitErrors = 0;
            let totalUnitSkipped = 0;
            let failureDetails = '';

            if (fs.existsSync(path)) {
              const files = fs.readdirSync(path);
              files.forEach(file => {
                if (file.endsWith('.txt')) {
                  const content = fs.readFileSync(`${path}/${file}`, 'utf8');
                  const match = content.match(/Tests run: (\d+), Failures: (\d+), Errors: (\d+), Skipped: (\d+)/);
                  if (match) {
                    totalUnitTests += parseInt(match[1]);
                    totalUnitFailures += parseInt(match[2]);
                    totalUnitErrors += parseInt(match[3]);
                    totalUnitSkipped += parseInt(match[4]);
                    
                    if (parseInt(match[2]) > 0 || parseInt(match[3]) > 0) {
                      // Strip execution time so subsequent runs can be compared accurately
                      const cleanContent = content.replace(/[,]?\s*Time elapsed: [\d.]+\s*s/g, '').trim();
                      failureDetails += `\n**${file}**\n\`\`\`\n${cleanContent}\n\`\`\`\n`;
                    }
                  }
                }
              });
            }

            const success = totalUnitFailures === 0 && totalUnitErrors === 0 && totalUnitTests > 0;
            const statusEmoji = success ? '‚úÖ' : '‚ùå';
            const statusText = success ? 'All unit tests passed!' : 'Unit tests failed!';

            const toolIdentifier = '<!-- tool: Unit Tests -->';
            let message = `${toolIdentifier}\n### ${statusEmoji} Unit Test Results: ${statusText}\n\n`;
            message += `| Metric | Count | Emoji |\n`;
            message += `| :--- | :--- | :--- |\n`;
            message += `| **Total Tests** | ${totalUnitTests} | üèÉ |\n`;
            message += `| **Passed** | ${totalUnitTests - totalUnitFailures - totalUnitErrors - totalUnitSkipped} | ‚úÖ |\n`;
            message += `| **Failures** | ${totalUnitFailures} | ‚ùå |\n`;
            message += `| **Errors** | ${totalUnitErrors} | ‚ö†Ô∏è |\n`;
            message += `| **Skipped** | ${totalUnitSkipped} | ‚è≠Ô∏è |\n\n`;

            if (!success && failureDetails) {
              message += `#### üîç Failure Details\n<details>\n<summary>Click to expand</summary>\n${failureDetails}\n</details>\n\n`;
            } else if (success) {
              message += `Great job! All ${totalUnitTests} tests are green! üåü‚ú®\n\n`;
            }

            if (totalUnitTests === 0) {
              message = `${toolIdentifier}\n‚ö†Ô∏è **No unit tests were found or ran.** Please check the build logs.`;
            }

            const prNumber = parseInt('${{ inputs.pr_number }}');
            const { data: pull } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            const headSha = pull.head.sha;

            // Fetch existing review threads via GraphQL
            const query = `query($owner:String!, $repo:String!, $number:Int!) {
              repository(owner:$owner, name:$repo) {
                pullRequest(number:$number) {
                  reviewThreads(first: 100) {
                    nodes {
                      id
                      isResolved
                      comments(first: 1) {
                        nodes {
                          id
                          body
                        }
                      }
                    }
                  }
                }
              }
            }`;
            const variables = { owner: context.repo.owner, repo: context.repo.repo, number: prNumber };
            const result = await github.graphql(query, variables);
            const threads = result.repository.pullRequest.reviewThreads.nodes;

            const existingThread = threads.find(t => t.comments.nodes[0] && t.comments.nodes[0].body.includes(toolIdentifier));

            if (existingThread) {
              if (existingThread.comments.nodes[0].body === message) {
                console.log("Comment content is identical. Skipping...");
              } else {
                console.log("Updating existing review thread...");
                await github.rest.pulls.updateReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingThread.comments.nodes[0].id,
                  body: message
                });
                
                // If the thread was resolved but we have failures again, unresolve it
                if (existingThread.isResolved && !success) {
                  await github.graphql(`mutation($id: ID!) { unresolveReviewThread(input: {threadId: $id}) { thread { isResolved } } }`, { id: existingThread.id });
                }
              }
            } else {
              console.log("Creating new review thread for unit tests...");
              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body: message,
                commit_id: headSha,
                path: 'SpringApi/pom.xml',
                subject_type: 'file'
              });
            }

            if (!success) {
               core.setFailed('Unit tests failed. Failing the build.');
            }
