name: Clean and Analyze code

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
    secrets:
      SNYK_TOKEN:
        required: true
      SONAR_TOKEN:
        required: true

jobs:
  spotless:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        # - name: Apply Spotless
        #   id: spotless
        #   working-directory: SpringApi
        #   run: |
        #     mvn spotless:apply
        #     if [ -n "$(git status --porcelain)" ]; then
        #       git add .
        #       git commit -m "style: apply spotless formatting"
        #       git push
        #       echo "has_changes=true" >> $GITHUB_OUTPUT
        #       # Capture names of changed files
        #       CHANGED=$(git log -1 --name-only --pretty=format:)
        #       # Replace platform-specific newlines with literal '\n'
        #       echo "files=${CHANGED//$'\n'/\\n}" >> $GITHUB_OUTPUT
        #     else
        #       echo "has_changes=false" >> $GITHUB_OUTPUT
        #     fi
        # - name: Comment Spotless Results
        # if: always()
        # uses: actions/github-script@v7
        # with:
        #   script: |
        #     const prNumber = parseInt('${{ inputs.pr_number }}');
        #     const identifier = '<!-- spotless-comment-id -->';
        #     const hasChanges = '${{ steps.spotless.outputs.has_changes }}' === 'true';

        #     let body = '';
        #     if (hasChanges) {
        #        body = `${identifier}\n### ðŸŽ¨ Spotless Formatting Applied\nFiles updated:\n\`\`\`\n${'${{ steps.spotless.outputs.files }}'.replace(/\\n/g, '\n')}\n\`\`\``;
        #     } else {
        #        body = `${identifier}\n### âœ… Spotless Check Passed\nNo formatting changes required.`;
        #     }

        #     const { data: comments } = await github.rest.issues.listComments({
        #       owner: context.repo.owner,
        #       repo: context.repo.repo,
        #       issue_number: prNumber
        #     });

        #     const existingComment = comments.reverse().find(c => c.body.includes(identifier));
        #     if (existingComment) {
        #       if (existingComment.body !== body) {
        #         await github.rest.issues.createComment({
        #           owner: context.repo.owner,
        #           repo: context.repo.repo,
        #           issue_number: prNumber,
        #           body: `ðŸ”„ **Formatting Update:**\n${body}`
        #         });
        #       }
        #     } else {
        #       await github.rest.issues.createComment({
        #         owner: context.repo.owner,
        #         repo: context.repo.repo,
        #         issue_number: prNumber,
        #         body: body
        #       });
        #     }

  snyk:
    # needs: spotless
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Snyk
        uses: snyk/actions/setup@806182742461562b67788a64410098c9d9b96adb
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Snyk Code test
        working-directory: SpringApi
        run: snyk code test --sarif > ../snyk-code.sarif || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Post Snyk Results
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');
            const identifier = '<!-- snyk-comment-id -->';
            const fs = require('fs');
            const sarifFile = 'snyk-code.sarif';

            let message = `${identifier}\n### âš¡ Snyk Security Scan\n`;
            if (fs.existsSync(sarifFile)) {
              const sarif = JSON.parse(fs.readFileSync(sarifFile, 'utf8'));
              const results = (sarif.runs && sarif.runs[0] && sarif.runs[0].results) || [];
              if (results.length > 0) {
                message += `Found ${results.length} security issues. Please review them.`;
              } else {
                message += `âœ… No security issues found!`;
              }
            } else {
              message += `âš ï¸ Snyk results file not found.`;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.reverse().find(c => c.body.includes(identifier));
            if (existingComment) {
              if (existingComment.body !== message) {
                 await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    body: `ðŸ“¡ **Snyk Update:**\n${message}`
                 });
              }
            } else {
               await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: message
               });
            }

  codeql:
    # needs: spotless
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          build-mode: none
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
      - name: Post CodeQL Comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');
            const identifier = '<!-- codeql-comment-id -->';
            const message = `${identifier}\n### ðŸ›¡ï¸ CodeQL Security Scan Completed\nResults are available in the Security tab of the repository.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.reverse().find(c => c.body.includes(identifier));
            if (!existingComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: message
              });
            }

  sonar:
    # needs: spotless
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven
      - name: Run Sonar Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=Ultimate-Company-New_Spring-Api
        working-directory: SpringApi
      - name: Post Sonar Comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');
            const identifier = '<!-- sonar-comment-id -->';
            const message = `${identifier}\n### ðŸ“¡ SonarCloud Analysis Completed\nPlease check the SonarCloud dashboard for detailed metrics and quality gate status.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.reverse().find(c => c.body.includes(identifier));
            if (!existingComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: message
              });
            }
